# Implementation Plan: Product Stock Restoration on Order Cancellation

**Branch**: `003-product-consumer-ordercancelled` | **Date**: 2025-09-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-product-consumer-ordercancelled/spec.md`

## Execution Flow (/plan command scope)
This plan was generated by following the execution flow steps. The results are documented below.

## Summary
This feature implements a consumer in the Product bounded context that listens for `OrderCancelled` integration events. Upon receiving an event, it will query the Order context for the cancelled order's details and restore the product quantities back to the inventory. This requires adding a new endpoint to `SaleOrders.WebApi` to expose order details.

## Technical Context
**Language/Version**: C# / .NET 8.0
**Primary Dependencies**: Wolverine.NET for message handling, Marten for persistence (in SaleProducts), ASP.NET Core for Web APIs.
**Storage**: PostgreSQL
**Testing**: xUnit
**Target Platform**: Linux container (via Docker)
**Project Type**: Service Component (background consumer) and API modification.
**Performance Goals**: N/A (focus on reliability and idempotency).
**Constraints**: Must not create direct database coupling between the Order and Product contexts.
**Scale/Scope**: The consumer must handle events for all cancelled orders.

## Constitution Check
*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

The plan adheres to the documented architecture (DDD, CQRS, Event-Driven). The use of an integration event and a separate consumer aligns with the separation of bounded contexts. The decision to use an API call to fetch data instead of sharing a database upholds the principle of context autonomy.

## Project Structure

### Documentation (this feature)
```
specs/003-product-consumer-ordercancelled/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
│   └── OrderDetailsResponse.cs
└── tasks.md             # Phase 2 output (/tasks command - NOT created by /plan)
```

### Source Code (repository root)
This feature will modify:
- `src/Product/DomainCore/SaleProducts.Applications/` (new command/handler for stock update)
- `src/Product/Presentation/SaleProducts.Consumer/` (new integration event handler)
- `src/Order/Presentation/SaleOrders.WebApi/` (new endpoint to get order details)
- `src/BC-Contracts/` (new DTO for the API response)

**Structure Decision**: The existing structure will be used. No new projects are needed.

## Phase 0: Outline & Research
Research has been conducted and consolidated in `research.md`. The key finding is that the `OrderCancelled` event only contains the `OrderId`, necessitating an API call to the `SaleOrders` context to fetch product details. This is a deviation from the initial assumption in the spec but is the correct architectural approach.

**Output**: [research.md](./research.md)

## Phase 1: Design & Contracts
Design artifacts have been created based on the research findings.

1.  **Data Model**: The local and remote data models are documented in `data-model.md`.
2.  **API Contracts**: A new DTO contract, `OrderDetailsResponse`, is defined in `contracts/OrderDetailsResponse.cs` to represent the data returned by the new `SaleOrders.WebApi` endpoint.
3.  **Quickstart**: A manual validation guide has been created in `quickstart.md`.

**Output**: [data-model.md](./data-model.md), [contracts/OrderDetailsResponse.cs](./contracts/OrderDetailsResponse.cs), [quickstart.md](./quickstart.md)

## Phase 2: Task Planning Approach
*This section describes what the /tasks command will do - DO NOT execute during /plan*

**Task Generation Strategy**:
- **Order Context**: 
  - Create a query and handler in `SaleOrders.Applications` to fetch order details.
  - Create a new GET endpoint in `SaleOrders.WebApi` at `/api/orders/{orderId}`.
- **Product Context**:
  - Create a new `RestockProductCommand` and handler in `SaleProducts.Applications`.
  - Create an API client service to call the new `SaleOrders.WebApi` endpoint.
  - Create the `OrderCancelled` integration event handler in `SaleProducts.Consumer`.
  - The handler will use the API client to get order details, then dispatch the `RestockProductCommand` for each item.
- **Testing**: Integration tests will be created to verify the end-to-end flow.

**Ordering Strategy**: API Endpoint in Order context → API Client in Product context → Consumer handler → Application logic.

## Phase 3+: Future Implementation
*These phases are beyond the scope of the /plan command*

## Complexity Tracking
| Violation | Why Needed | Simpler Alternative Rejected Because |
|---|---|---|
| Cross-service communication (API call) | The `OrderCancelled` event lacks product details. The Product context needs this data to perform its function. | Enriching the event was rejected to keep event payloads small. A shared database was rejected as it violates bounded context autonomy. |

## Progress Tracking
- [X] Phase 0: Research complete
- [X] Phase 1: Design complete
- [X] Phase 2: Task planning approach described
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:
- [X] Initial Constitution Check: PASS
- [X] Post-Design Constitution Check: PASS
- [X] All NEEDS CLARIFICATION resolved
- [X] Complexity deviations documented

---
*Based on project guidelines in AGENTS.md*
