---
description: 在任務產生後，對 spec.md、plan.md 和 tasks.md 執行一次非破壞性的跨產物一致性與品質分析。
---

使用者輸入可以直接由代理提供，或作為命令參數傳入 - 在繼續執行提示之前，您 **必須** 考慮它（如果非空）。

使用者輸入：

$ARGUMENTS

目標：在實作前，識別三個核心產物（`spec.md`、`plan.md`、`tasks.md`）中的不一致、重複、模稜兩可和規格不明確的項目。此命令 **必須** 在 `/tasks` 成功產生完整的 `tasks.md` 之後才能執行。

**嚴格唯讀**：**請勿** 修改任何檔案。輸出一份結構化的分析報告。提供一個可選的修復計畫（使用者必須明確批准後，才能手動調用任何後續的編輯命令）。

**章程權威**：專案章程（`.specify/memory/constitution.md`）在此分析範圍內是 **不可協商的**。章程衝突會自動被視為 **嚴重（CRITICAL）**，並且需要調整規格、計畫或任務——而不是對原則進行稀釋、重新解釋或默許忽略。如果原則本身需要變更，則必須在 `/analyze` 之外，透過一個獨立、明確的章程更新來進行。

執行步驟：

1. 從 repo 根目錄執行一次 `.specify/scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks`，並解析 JSON 以取得 `FEATURE_DIR` 和 `AVAILABLE_DOCS`。推導出絕對路徑：
   - SPEC = FEATURE_DIR/spec.md
   - PLAN = FEATURE_DIR/plan.md
   - TASKS = FEATURE_DIR/tasks.md
   如果任何必要檔案遺失，則中止並顯示錯誤訊息（指示使用者執行遺失的先決條件命令）。

2. 載入產物：
   - 解析 spec.md 區段：總覽/脈絡、功能性需求、非功能性需求、使用者故事、邊界案例（如果存在）。
   - 解析 plan.md：架構/技術棧選擇、資料模型參考、階段、技術限制。
   - 解析 tasks.md：任務 ID、描述、階段分組、並行標記 [P]、參考的檔案路徑。
   - 載入章程 `.specify/memory/constitution.md` 以進行原則驗證。

3. 建立內部語意模型：
   - 需求清單：每個功能性 + 非功能性需求都有一個穩定的鍵（根據祈使句推導 slug；例如，「使用者可以上傳檔案」 -> `user-can-upload-file`）。
   - 使用者故事/動作清單。
   - 任務覆蓋對應：將每個任務對應到一個或多個需求或故事（透過關鍵字 / 明確的參考模式如 ID 或關鍵片語進行推斷）。
   - 章程規則集：提取原則名稱和任何 MUST/SHOULD 的規範性陳述。

4. 偵測階段：
   A. 重複偵測：
      - 識別幾乎重複的需求。標記品質較低的措辭以進行整合。
   B. 模稜兩可偵測：
      - 標記缺乏可衡量標準的模糊形容詞（快速、可擴展、安全、直觀、強健）。
      - 標記未解決的佔位符（TODO, TKTK, ???, <placeholder> 等）。
   C. 規格不詳盡：
      - 有動詞但缺少目標或可衡量結果的需求。
      - 缺少驗收標準對齊的使用者故事。
      - 引用了 spec/plan 中未定義的檔案或元件的任務。
   D. 章程對齊：
      - 任何與 MUST 原則衝突的需求或計畫元素。
      - 缺少章程中強制要求的區段或品質閘門。
   E. 覆蓋缺口：
      - 沒有關聯任務的需求。
      - 沒有對應到需求/故事的任務。
      - 未反映在任務中的非功能性需求（例如，效能、安全性）。
   F. 不一致：
      - 術語漂移（同一概念在不同檔案中命名不同）。
      - 計畫中引用的資料實體在規格中不存在（或反之）。
      - 任務排序矛盾（例如，整合任務在基礎設定任務之前，且無相依性註記）。
      - 相互衝突的需求（例如，一個要求使用 Next.js，而另一個則說要使用 Vue 作為框架）。

5. 嚴重性指派啟發式規則：
   - **嚴重（CRITICAL）**：違反章程的 MUST 原則、缺少核心規格產物，或沒有任何任務覆蓋且會阻擋基準功能的需求。
   - **高（HIGH）**：重複或衝突的需求、模稜兩可的安全性/效能屬性、無法測試的驗收標準。
   - **中（MEDIUM）**：術語漂移、缺少非功能性任務覆蓋、規格不詳盡的邊界案例。
   - **低（LOW）**：風格/措辭改進、不影響執行順序的次要冗餘。

6. 產生一份 Markdown 報告（不寫入檔案），包含以下區段：

   ### 規格分析報告
   | ID | 類別 | 嚴重性 | 位置 | 摘要 | 建議 |
   |----|----------|----------|-------------|---------|----------------|
   | A1 | 重複 | 高 | spec.md:L120-134 | 兩個相似的需求... | 合併措辭；保留較清晰的版本 |
   （每個發現新增一列；產生以類別首字母為前綴的穩定 ID。）

   額外子區段：
   - 覆蓋摘要表：
     | 需求鍵 | 是否有任務？ | 任務 ID | 備註 |
   - 章程對齊問題（如有）
   - 未對應的任務（如有）
   - 指標：
     * 總需求數
     * 總任務數
     * 覆蓋率 %（有 >=1 個任務的需求）
     * 模稜兩可計數
     * 重複計數
     * 嚴重問題計數

7. 在報告結尾，輸出一份簡潔的「後續動作」區塊：
   - 如果存在嚴重問題：建議在執行 `/implement` 之前解決。
   - 如果只有低/中度問題：使用者可以繼續，但提供改進建議。
   - 提供明確的命令建議：例如，「執行 /specify 進行精煉」、「執行 /plan 調整架構」、「手動編輯 tasks.md 為 'performance-metrics' 新增覆蓋」。

8. 詢問使用者：「您是否希望我為前 N 個問題建議具體的修復編輯？」（請勿自動套用。）

行為規則：
- **絕不** 修改檔案。
- **絕不** 虛構遺失的區段——如果不存在，就報告它們不存在。
- **保持** 發現的確定性：如果在沒有變更的情況下重新執行，應產生一致的 ID 和計數。
- 將主表中的總發現 **限制** 在 50 個以內；將其餘部分匯總在一個摘要溢出註記中。
- 如果未發現任何問題，則發布一份包含覆蓋率統計數據和繼續執行建議的成功報告。

脈絡：$ARGUMENTS
