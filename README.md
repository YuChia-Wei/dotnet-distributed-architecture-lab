> this readme was generated by gemini cli (model: 2.5 pro).

# MQArchLab - 基於 .NET 的現代化訊息驅動架構實踐

MQArchLab 是一個採用 .NET 9、容器化技術和現代軟體架構原則（如 Clean Architecture、DDD、CQRS）建構的範例專案。此專案旨在展示如何設計和開發一個可擴展、具備韌性且易於維護的後端系統。

專案包含兩個核心業務領域：**訂單 (SaleOrders)** 和 **產品 (SaleProducts)**，並透過 RabbitMQ 或 Kafka 進行非同步通訊。

## 架構原則

本專案嚴格遵循以下架構原則：

- **Clean Architecture (CA):** 強制性的關注點分離和依賴規則，確保業務邏輯的獨立性。
- **Domain-Driven Design (DDD):** 專注於核心業務領域和領域邏輯。
- **Command Query Responsibility Segregation (CQRS):** 將讀取和寫入操作分離，以優化效能和可擴展性。

## 核心技術

- **主要框架:** .NET 9
- **主要語言:** C#
- **訊息/命令/查詢處理:** WolverineFx
- **資料庫:** PostgreSQL
- **訊息代理:** RabbitMQ / Kafka
- **容器化:** Docker

## 如何啟動專案

本專案已完全容器化，您只需要在本機安裝 Docker 和 Docker Compose 即可輕鬆啟動。

1.  **選擇訊息代理 (Message Broker)**

    在 `docker-compose/docker-compose.yml` 檔案中，您可以透過設定 `QUEUE_SERVICE` 環境變數來選擇要使用的訊息代理。

    - **使用 Kafka (預設):**
      ```yaml
      # 在 orders-api, orders-consumer, product-api, product-consumer 中
      environment:
        - QUEUE_SERVICE=Kafka
      ```

    - **使用 RabbitMQ:**
      將 `QUEUE_SERVICE` 的值改為 `RabbitMQ`。
      ```yaml
      # 在 orders-api, orders-consumer, product-api, product-consumer 中
      environment:
        - QUEUE_SERVICE=RabbitMQ
      ```

2.  **Clone 專案庫**
    ```bash
    git clone https://github.com/YuChia/dotnet-mq-arch-lab.git
    cd dotnet-mq-arch-lab
    ```

3.  **使用 Docker Compose 啟動所有服務**
    在專案根目錄下，執行以下指令：
    ```bash
    docker-compose -f ./docker-compose/docker-compose.yml up -d
    ```
    此指令將會建置並啟動所有必要的服務，包括：
    - `orders-api`
    - `orders-consumer`
    - `product-api`
    - `product-consumer`
    - `postgres`
    - `rabbitmq` (如果選擇 RabbitMQ)
    - `kafka` (如果選擇 Kafka)
    - `kafka-ui` (如果選擇 Kafka)

## API 文件 (Scalar)

專案的 Web API 提供了基於 Scalar 的互動式 API 文件。當專案成功啟動後，您可以透過以下連結存取：

- **訂單服務 (Orders API):**
  - **API 文件:** [http://localhost:8080/scalar/v1](http://localhost:8080/scalar/v1)
  - **OpenAPI Spec:** [http://localhost:8080/openapi/v1](http://localhost:8080/openapi/v1)

- **產品服務 (Products API):**
  - **API 文件:** [http://localhost:8090/scalar/v1](http://localhost:8090/scalar/v1)
  - **OpenAPI Spec:** [http://localhost:8090/openapi/v1](http://localhost:8090/openapi/v1)

## 服務監控

- **Kafka UI:**
  當使用 Kafka 時，您可以透過 [http://localhost:8088](http://localhost:8088) 來存取 Kafka UI。

- **RabbitMQ Management UI:**
  當使用 RabbitMQ 時，您可以透過 [http://localhost:15672](http://localhost:15672) 來監控 RabbitMQ 的佇列和訊息。
  - **帳號:** `guest`
  - **密碼:** `guest`

## 其他設計相關的分析文章

- [order / product 中的 command/command handler 做法比較](./doc/command-handler-comparison-of-practices.md)

## PRD 與 AI Coding Agents 使用

- **範本位置:** 使用 `PRD/templates/modular/en`、`PRD/templates/modular/zh-TW` 的模組化段落範本；若需要單一檔案，使用 `PRD/templates/single-file`。
- **建立新 PRD:** 將對應語系範本複製到 `PRD/<Service or Feature>/<lang>`（例：`PRD/Orders/zh-TW`），並依序填寫 `01`～`06` 段落。
- **結構說明:** 各段落對應 Summary、Goals、Non‑Goals、Constraints、Acceptance Criteria、Plan；詳細請見 `PRD/README.md`。
- **單檔輸出:** 如需分享單檔，可在文件流程或 CI 任務中依檔名順序合併。

### 在 AI Agent 中撰寫 Prompt（範例）

- **通用重點:**
  - **指向路徑:** 明確指到 `PRD/<Feature>/<lang>` 或 `PRD/templates/...`。
  - **遵循限制:** 要求遵循 Clean Architecture、DDD、CQRS，DI 擴充方法（如 `AddApplicationServices`、`AddInfrastructureServices`），命名與路徑規範，Dockerfile 與 compose 規則。
  - **代理設定:** Broker 以 `QUEUE_SERVICE=Kafka|RabbitMQ` 及 `ConnectionStrings__KafkaBroker` 或 `ConnectionStrings__MessageBroker` 控制。
  - **驗收條件:** 要求能 `dotnet restore && dotnet build`、可 `dotnet run`、API/Consumer 行為符合 PRD、`dotnet test` 通過。

- **gemini cli 範例 Prompt:**
  - `請依據 PRD 位於 \`PRD/Orders/zh-TW\` 的 01～06 段落，實作訂單服務 API 與對應 Consumer。嚴格遵守 PRD 的 Constraints（Clean Architecture、DDD、CQRS、DI 規範、Dockerfile）。Broker 以環境變數切換（\`QUEUE_SERVICE\`）。完成後更新 API 的 *Request/*Response DTO 與公開摘要（zh-TW），並確保在方案根目錄可建置與執行。`

- **codex cli 範例 Prompt:**
  - `Use the modular PRD at \`PRD/Products/en\`. Implement endpoints from sections 01–06. Follow constraints: Clean Architecture + DDD + CQRS, DI extensions, folder/namespace rules, and Dockerfile for executables. Broker via \`QUEUE_SERVICE\`. After changes, run \`dotnet restore && dotnet build\` and ensure tests pass.`

- **claude code cli 範例 Prompt:**
  - `根據 \`PRD/templates/modular/zh-TW\` 的結構，替產品上下文建立新的 PRD 於 \`PRD/SaleProducts/zh-TW\`，並依此實作 API/Consumer 雛形。請撰寫必要的 DI 擴充方法與 Dockerfile，多語系註解以 zh-TW 為主，並符合驗收準則（建置/執行/測試）。`

## 貢獻者與 AI 指南

- 英文版指南：參見 `AGENTS.md`（本庫唯一的 AI 與貢獻者說明）
- 正體中文版：參見 `AGENTS.zh-TW.md`
