# 摘要

本 PRD 描述「產品（SaleProducts）」服務的現況與期望行為。服務提供產品的新增、查詢、更新、刪除 API，採 Clean Architecture + DDD + CQRS；資料層目前以記憶體儲存實作（已註冊 PostgreSQL 連線但未使用），訊息整合透過 Wolverine，並可依環境變數切換 Kafka 或 RabbitMQ。

現況重點（依程式碼盤點）：
- API（`api/Products`）
  - `POST /api/Products` 建立產品，回傳 `ProductResponse`（Id, Name, Description, Price, Stock）。
  - `GET /api/Products` 取得全部產品清單。
  - `GET /api/Products/{id}` 依 Id 取得產品。
  - `PUT /api/Products/{id}` 更新產品。
  - `DELETE /api/Products/{id}` 刪除產品。
- DTO 命名：輸入 `CreateProductRequest` / `UpdateProductRequest`；輸出 `ProductResponse`。
- Domain：`Product` 聚合根，方法 `Update/IncreaseStock/DecreaseStock/Delete`；建立/更新/刪除時分別產生 `ProductCreated/ProductUpdated/ProductDeleted` 領域事件。
- 應用層：命令 `Create/Update/Delete` 與查詢 `GetAll/GetById`，對應的 Handler 已實作。
- 基礎設施：`ProductDomainRepository` 使用記憶體 List 作為儲存（與註冊的 `IDbConnection` 不一致），未見領域事件派送。
- 整合事件：WebApi 設定 Wolverine 發布 `IIntegrationEvent` 至 `products` Topic/Queue，但目前應用/基礎層未見發布整合事件之用例；Consumer 端（於 Product context）監聽 `orders` Topic/Queue 並處理 `OrderPlaced` 事件（僅記錄 Log，未更新庫存）。

風險與疑慮：
- 儲存實作與設定不一致：已註冊 Npgsql/`IDbConnection`，但 Repository 為記憶體實作，資料會隨執行期消失。
- 領域事件未派送：Repository 未呼叫 `IDomainEventDispatcher`，導致 `ProductCreated/Updated/Deleted` 事件未被傳出。
- 整合事件流程不明：WebApi 已設定 `products` Topic/Queue，但未有對應的整合事件發佈邏輯。
- 跨情境整合：Product.Consumer 監聽 `orders` 的 `OrderPlaced`，目前僅記錄 Log；是否應同步扣庫存需確認。
